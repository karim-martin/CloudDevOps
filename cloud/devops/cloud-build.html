<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Cloud Build - Serverless CI/CD for containers.">
  <title>Cloud Build | CloudDevOps</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="icon" type="image/svg+xml" href="../../assets/images/logo.svg">
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <header class="site-header"><div class="header-container"><a href="../../" class="logo"><img src="../../assets/images/logo.svg" alt=""><span>CloudDevOps</span></a><nav class="main-nav"><a href="../../devops/" class="nav-link">DevOps</a><a href="../../cloud/" class="nav-link active">Cloud</a><a href="../../app-deploy/" class="nav-link">App Deploy</a></nav><div class="header-actions"><button class="mobile-menu-toggle" aria-label="Open menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button></div></div></header>
  <div class="sidebar-overlay"></div>
  <div class="page-wrapper">
    <aside class="sidebar"><nav class="sidebar-nav">
      <div class="sidebar-section"><h3 class="sidebar-section-title">DevOps</h3><ul class="sidebar-links">
        <li><a href="./">Overview</a></li>
        <li><a href="./cloud-build.html" class="active">Cloud Build</a></li>
        <li><a href="./cloud-deploy.html">Cloud Deploy</a></li>
      </ul></div>
    </nav></aside>
    <main id="main-content" class="main-content">
      <article class="content-article">
        <header class="article-header"><h1>Cloud Build</h1></header>
        <div class="article-body">
          <p>Cloud Build is a serverless CI/CD platform that executes builds on GCP infrastructure.</p>

          <h2>cloudbuild.yaml</h2>
          <pre><code class="language-yaml"># Basic build
steps:
  # Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA', '.']

  # Push to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA']

images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA'</code></pre>

          <h2>.NET Build</h2>
          <pre><code class="language-yaml">steps:
  # Restore dependencies
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    args: ['dotnet', 'restore']

  # Run tests
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    args: ['dotnet', 'test', '--no-restore']

  # Build image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/api:$COMMIT_SHA'
      - '-f'
      - 'src/Api/Dockerfile'
      - '.'

  # Push image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/api:$COMMIT_SHA']

images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/api:$COMMIT_SHA'

options:
  machineType: 'E2_HIGHCPU_8'</code></pre>

          <h2>React/Node Build</h2>
          <pre><code class="language-yaml">steps:
  # Install dependencies
  - name: 'node:20'
    args: ['npm', 'ci']

  # Run tests
  - name: 'node:20'
    args: ['npm', 'test']

  # Build application
  - name: 'node:20'
    args: ['npm', 'run', 'build']

  # Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/frontend:$COMMIT_SHA'
      - '.'

  # Push image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/frontend:$COMMIT_SHA']

images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/frontend:$COMMIT_SHA'</code></pre>

          <h2>Deploy to GKE</h2>
          <pre><code class="language-yaml">steps:
  # Build image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA', '.']

  # Push image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA']

  # Get GKE credentials
  - name: 'gcr.io/cloud-builders/gke-deploy'
    args:
      - 'run'
      - '--filename=k8s/'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA'
      - '--location=us-central1'
      - '--cluster=my-cluster'

images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/my-repo/app:$COMMIT_SHA'</code></pre>

          <h2>Substitutions</h2>
          <pre><code class="language-yaml">steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_IMAGE}:$COMMIT_SHA', '.']

substitutions:
  _REGION: us-central1
  _REPO: my-repo
  _IMAGE: app

# Override at runtime:
# gcloud builds submit --substitutions=_IMAGE=api</code></pre>

          <h2>Triggers</h2>
          <pre><code class="language-bash"># Create trigger from GitHub
gcloud builds triggers create github \
    --name="build-on-push" \
    --repo-name="my-repo" \
    --repo-owner="my-org" \
    --branch-pattern="^main$" \
    --build-config="cloudbuild.yaml"

# Create trigger for tags
gcloud builds triggers create github \
    --name="build-on-tag" \
    --repo-name="my-repo" \
    --repo-owner="my-org" \
    --tag-pattern="^v.*" \
    --build-config="cloudbuild.yaml"

# List triggers
gcloud builds triggers list

# Run trigger manually
gcloud builds triggers run build-on-push --branch=main</code></pre>

          <h2>Private Pools</h2>
          <pre><code class="language-bash"># Create private pool (for VPC access)
gcloud builds worker-pools create my-pool \
    --region=us-central1 \
    --peered-network=projects/PROJECT/global/networks/my-vpc

# Use in cloudbuild.yaml
options:
  pool:
    name: 'projects/PROJECT/locations/us-central1/workerPools/my-pool'</code></pre>

          <h2>Secrets in Builds</h2>
          <pre><code class="language-yaml">steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'app', '--build-arg', 'NPM_TOKEN=$$NPM_TOKEN', '.']
    secretEnv: ['NPM_TOKEN']

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/npm-token/versions/latest
      env: 'NPM_TOKEN'</code></pre>

          <h2>Common Commands</h2>
          <pre><code class="language-bash"># Submit build
gcloud builds submit --config=cloudbuild.yaml

# Submit with Dockerfile (no config)
gcloud builds submit --tag=us-central1-docker.pkg.dev/PROJECT/repo/image

# List builds
gcloud builds list

# View build logs
gcloud builds log BUILD_ID

# Cancel build
gcloud builds cancel BUILD_ID</code></pre>

          <h2>Service Account Permissions</h2>
          <pre><code class="language-bash"># Cloud Build service account needs roles:
# - roles/artifactregistry.writer (push images)
# - roles/container.developer (deploy to GKE)
# - roles/secretmanager.secretAccessor (access secrets)

PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format='value(projectNumber)')
CB_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:${CB_SA}" \
    --role="roles/container.developer"</code></pre>
        </div>
      </article>
    </main>
  </div>
  <footer class="site-footer"><div class="footer-container"><p class="copyright">CloudDevOps</p></div></footer>
  <script src="../../assets/js/navigation.js"></script><script src="../../assets/js/main.js"></script>
</body>
</html>
